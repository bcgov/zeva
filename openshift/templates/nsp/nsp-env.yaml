---
kind: Template
apiVersion: v1
labels:
  template: zeva-nsp
metadata:
  name: zeva-nsp
  creationTimestamp:
parameters:
  - name: ENV_NAME
    displayName: Environment Name
    description: Environment Name
    required: true
objects:
  - kind: NetworkSecurityPolicy
    apiVersion: secops.pathfinder.gov.bc.ca/v1alpha1
    metadata:
      name: custom-pods-to-api-zeva
    spec:
      description: |
        Allow pods to talk to the internal OCP api so deployments work.
        This only needs to be specified once per environment.
        Without this policy, pods could have PU Update error when starting container
      source:
      - - $namespace=tbiwaq-${ENV_NAME}
      destination:
      - - int:network=internal-cluster-api-endpoint

  - kind: NetworkSecurityPolicy
    apiVersion: secops.pathfinder.gov.bc.ca/v1alpha1
    metadata:
      name: custom-internet-to-envoy
    spec:
      description: |
        Allow envoy to accept requests from internet.
        Also allow envy to communication with kKeycloak.
      source:
        - - ext:network=any
      destination:
        - - app=zeva
          - role=envoy
          - env=${ENV_NAME}

  - kind: NetworkSecurityPolicy
    apiVersion: secops.pathfinder.gov.bc.ca/v1alpha1
    metadata:
      name: custom-envy-to-frontend
    spec:
      description: |
        Allow envoy to talk with frontend.
      source:
        - - app=zeva
          - role=envoy
          - env=${ENV_NAME}
      destination:
        - - app=zeva
          - role=frontend
          - env=${ENV_NAME}

  - kind: NetworkSecurityPolicy
    apiVersion: secops.pathfinder.gov.bc.ca/v1alpha1
    metadata:
      name: custom-envy-to-python-backend
    spec:
      description: |
        Allow envoy to talk with python backend.
      source:
        - - app=zeva
          - role=envoy
          - env=${ENV_NAME}
      destination:
        - - app=zeva
          - role=python-backend
          - env=${ENV_NAME}

  - kind: NetworkSecurityPolicy
    apiVersion: secops.pathfinder.gov.bc.ca/v1alpha1
    metadata:
      name: custom-python-backend-to-postgresql
    spec:
      description: |
        Allow python-backend to talk with postgresql database
      source:
        - - app=zeva
          - role=python-backend
          - env=${ENV_NAME}
      destination:
        - - app=zeva
          - role=postgresql
          - env=${ENV_NAME}
